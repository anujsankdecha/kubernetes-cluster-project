pipeline {
    agent {
        label 'jenkins-slave'
    }
    options {
        timeout(time: 1, unit: 'HOURS')
        buildDiscarder(logRotator(numToKeepStr: '3'))
    }
    environment {
        // Path to the kubeconfig file in workspace
        KUBECONFIG = "${WORKSPACE}/kubeconfig"
    }
    stages {
        stage("App code Checkout") {
            steps {
                git branch: 'main', url: 'https://github.com/anujsankdecha/kubernetes-cluster-project.git'
            }
        }

        stage('Deploy pods') {
            steps {
                withCredentials([file(credentialsId: 'kube-config', variable: 'KUBECONFIG_FILE')]) {
                    sh '''
                      # Copy kubeconfig from credentials to workspace
                      cp $KUBECONFIG_FILE $KUBECONFIG
                      chmod 600 $KUBECONFIG

                      # Explicitly set Kubernetes master IP in kubeconfig
                      kubectl config set-cluster kubernetes --server=https://192.168.0.50:6443 --kubeconfig=$KUBECONFIG
                      kubectl config set-context --current --cluster=kubernetes --kubeconfig=$KUBECONFIG

                      # Test connection to the cluster
                      kubectl get nodes --kubeconfig=$KUBECONFIG

                      # Apply Kubernetes manifests
                      kubectl apply -f kubernetes-deploy/namespace.yaml
                      kubectl apply -f kubernetes-deploy/deployment.yaml
                      kubectl apply -f kubernetes-deploy/service.yaml
                    '''
                }
            }
        }
    }
}
