pipeline {
    agent {
        label 'jenkins-agent'
    }
    options {
        timeout(time: 1, unit: 'HOURS')
        buildDiscarder(logRotator(numToKeepStr: '3'))
    }
    environment {
        // Path to the kubeconfig file
        KUBECONFIG = "${WORKSPACE}/kubeconfig"
    }
    stages {
        stage("App code Checkout"){
            steps {
                git branch: 'main', url:'https://github.com/anujsankdecha/kubernetes-cluster-project.git'
            }
        }

        stage('Deploy pods') {
            steps {
                withCredentials([file(credentialsId: 'kube-config', variable: 'KUBECONFIG_FILE')]) {
                    sh '''
                      cp $KUBECONFIG_FILE $KUBECONFIG
                      chmod 600 $KUBECONFIG
                      kubectl apply -f kubernetes-deploy/namespace.yaml
                      kubectl apply -f kubernetes-deploy/deployment.yaml
                      kubectl apply -f kubernetes-deploy/service.yaml
                    '''
                }
            }
        }
    }
}            