pipeline {
    agent {
        label 'jenkins-agent'
    }
    options {
        timeout(time: 1, unit: 'HOURS')
        buildDiscarder(logRotator(numToKeepStr: '3'))
    }

    environment {
        SSHOME = tool 'sonar-scanner'
        DOCKER_REGISTRY_CREDS = credentials('docker-creds')
    }

    stages {
        stage("App code Checkout") {
            steps {
                git branch: 'main', url: 'https://github.com/anujsankdecha/kubernetes-cluster-project.git'
            }
        }

        stage("Sonar Analysis") {
            steps {
                dir('src/') {
                    withSonarQubeEnv('sonar-server') {
                        sh """ 
                            ${SSHOME}/bin/sonar-scanner \
                            -Dsonar.projectKey=villa-agency-project \
                            -Dsonar.projectName=villa-agency-project \
                            -Dsonar.sources=. \
                            -Dsonar.host.url=\${SONAR_HOST_URL} \
                            -Dsonar.token=\${SONAR_AUTH_TOKEN}
                        """  
                    }
                }
            }
        }

        stage('QualityGate') {
            steps {
                timeout(time: 5, unit: 'MINUTES') {
                    script {
                        // don't abort the pipeline if SonarQube QG is unavailable
                        def qg = waitForQualityGate abortPipeline: false
                        echo "Quality Gate raw result object: ${qg}"
                        if (qg == null) {
                            echo "QualityGate result unavailable (timed out or webhook not configured). Marking build UNSTABLE and continuing."
                            currentBuild.result = 'UNSTABLE'
                        } else {
                            echo "Quality Gate status: ${qg.status}"
                            if (qg.status == 'ERROR') {
                                // Quality gate failed â€” mark unstable or fail as you prefer
                                echo "Quality gate FAILED. Marking build UNSTABLE."
                                currentBuild.result = 'UNSTABLE'
                            } else if (qg.status == 'OK') {
                                echo "Quality gate passed."
                            } else {
                                echo "Quality gate status: ${qg.status} (treating as UNSTABLE)"
                                currentBuild.result = 'UNSTABLE'
                            }
                        }
                    }
                }
            }
        }

        stage("Scan CODEFS") {
            steps {
                sh "trivy fs --exit-code 0 src/ > /tmp/trivyscanfs-${BUILD_NUMBER}.txt 2>&1 || true"
                sh "cat /tmp/trivyscanfs-${BUILD_NUMBER}.txt"
            }
        }

        stage("Build Image") {
            steps {
                // Keep this in a script block if you plan additional logic later
                script {
                    // Check if Dockerfile exists
                    sh "ls -la Dockerfile || echo 'Dockerfile not found'"
                    sh "docker build -t anujgajjar/villaimage:${BUILD_NUMBER} ."
                }
            }
        }

        stage("Scan Image Trivy") {
            steps {
                sh "trivy image --exit-code 0 anujgajjar/villaimage:${BUILD_NUMBER} > /tmp/trivyscan-${BUILD_NUMBER}.txt 2>&1 || true"
                sh "cat /tmp/trivyscan-${BUILD_NUMBER}.txt"
            }
        }

        stage("Image Push to Registry") {
            steps {
                script {
                    sh "docker login -u $DOCKER_REGISTRY_CREDS_USR -p $DOCKER_REGISTRY_CREDS_PSW"
                    sh "docker push anujgajjar/villaimage:${BUILD_NUMBER}"
                    sh "docker rmi anujgajjar/villaimage:${BUILD_NUMBER} || true"
                }
            }
        }
    }

    post {
        always {
            // run cleanup on an agent workspace (provides hudson.FilePath)
            node {
                echo "Pipeline completed - Build ${BUILD_NUMBER}"
                // Cleanup trivy scan files
                sh "rm -f /tmp/trivyscan*.txt || true"
            }
        }
        success {
            echo "Pipeline succeeded!"
        }
        failure {
            echo "Pipeline failed!"
        }
    }
}
